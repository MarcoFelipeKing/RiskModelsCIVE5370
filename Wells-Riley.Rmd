---
title: "Risk of Airborne Infection Transmission in Indoor Spaces"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: menu
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(devtools)
library(plotly)
library(shinyWidgets)
# devtools::install_github("joelkuiper/personograph")
library(personograph)
```

Column {.sidebar}
-----------------------------------------------------------------------

<!-- 1. Select a input parameters:  -->
  
Use the <b>drop-down menu</b> and <b>sliders </b> 1 to 4 to predict the risk of infection in a room. Investigate the effect of mitigation strategies by changing the ventilation strategy and masking rates.
```{r}

selectInput("q", label = h4("1. Infection of interest:"), 
    choices = list("SARS-2" = 25, "Measels" = 400, "Tuberculosis" = 13), 
    selected = 25)
    
selectInput("V", label = h4("2. Type of room:"), 
    choices = list("Small Meeting Room (4 occupants)" = 3*3*3, 
                   "Hot-desking office (10 occupants)" = 4*4*4,
                   "Lecture theatre (80 occupants)" = 10*10*3.5
                  ), 
    selected =3*3*3)

selectInput("fresh_flow", label = h4("3. How is the room ventilated:"), 
    choices = list("Window Open a Crack" = 2.5, 
                   "Mechanical Ventilation" = 6,
                   "Open Door and Open Windows" = 8,
                   "Air Conditioning Unit" = 0.2,
                   "No Appreciable Ventilation" = 0.1), 
    selected = 2.5)


# sliderInput("S", label = h4("Number of People in Room (-):"),
#             min = 10, max = 200, value = 50, step = 5)
 
# sliderInput("I", label = h4("Number of Infectors (-):"),
#             min = 1, max = 3, value = 1, step = 1)


# sliderInput(inputId = "tmax",label = h4("4. How long is the room cccupied [hrs]:"),
#             min = 1, max = 24,value=24,step=1)


# selectInput(inputId = "V",label = "How is your room ventilated:", choices = c("Openable Windows","Mechanical Ventilation","Air conditioning unit","No Appreciable Ventilation"),selected = "No Appreciable Ventilation")

shinyWidgets::sliderTextInput(inputId = "maskProp",
                              label = h4("4. Percentage of people wearing masks [%]:"),
                              grid = TRUE,
                              force_edges = TRUE,
                              choices = c(0,10,20,30,40,50,60,70,80,90,100),selected = 80)


# selectizeInput("dropExhale", label = h4("Expert setting: Modelling engine choice "),
#                choices= list(`Coughing` = list("BLO coughing" = "2", "Duguid" = "4", "L&R" = "5"),
#                              `Speaking` = list("BLO speaking" = "3"),
#                              `Breathing` = list("BLO breathing" = "1")))
```

<!-- si la persona infectada lleva mascarilla entonces el 0.5 aplica a q, no a p -->
<!-- N_E = S_1(1-exp{...p}) + S_2(1-exp{...0.5p}) -->
<!-- multiplicas por p (pulmonary rate), osea que si consideras 0.5p lo que dices es que esa persona respira el 50% -->

Column {data-width=650}
-----------------------------------------------------------------------

<!-- ### How to use this dashboard: -->

<!-- This dashboard tool is intended as a way of evaluating current exposure from airborne infectionn in an indoor space.  -->

<!-- * **Airborne Risk**:  Evaluate the risk of infection from an airborne microorganism by using the sliders and drop-down menus select the type of room, type of ventilation and number of occupants. -->
<!-- * **Mitigation Strategies**: you can control the risk by investigating "what-if" scenarios, including what happens if 50% of the participatns are masked versus if you can open a window. -->

### Airborne Risk

```{r Concentration, echo=FALSE,warning=FALSE}
# C <- function(tmax,lambdaV,lambdaD,lambdaR,q,V){
#   
#   lambda=lambdaV+lambdaD+lambdaR
#   t=seq(0,tmax,by=0.1)
#   return(q/(V*lambda)*(1-exp(-lambda*t)))
#   
# }

# FIXME multiplicas por p (pulmonary rate), osea que si consideras 0.5p lo que dices es que esa persona respira el 50%
# FIXME porque el otro 50% que respira esta limpio y no hace falta considerarlo)
# FIXME osea que creo que tiene sentido considerar
# FIXME N_E = S_1(1-exp{...p}) + S_2(1-exp{...0.5p})
# FIXME donde S_1 es el numero de susceptibles sin mascarilla y S_2 con mascarilla

S <- reactive(
  {
    if(input$V==3*3*3) {
      s=4
    } else if(input$V==4*4*4) {
      s=10
    } else {
      s=80
    }
    return(data.frame(s=s))
  }
)


N1 <- function(p,q,Q,t,S,I){
  return(S*(1-exp(-p*I*q/Q*t)))
}

WR<-reactive({

  
  df <- data.frame(
    time=seq(0,12,0.1),
    standard=N1(0.6,as.numeric(input$q),as.numeric(input$fresh_flow)*as.numeric(input$V),seq(0,12,0.1),S()$s,1),
    masked=N1(0.6,as.numeric(input$q),as.numeric(input$fresh_flow)*as.numeric(input$V),seq(0,12,0.1),S()$s*(1-as.numeric(input$maskProp)/100),1)+N1(0.6*0.5,as.numeric(input$q),as.numeric(input$fresh_flow)*as.numeric(input$V),seq(0,12,0.1),S()$s*(as.numeric(input$maskProp)/100),1),
    extra_ventilation=N1(0.6,as.numeric(input$q),as.numeric(input$fresh_flow)*as.numeric(input$V)*1.2,seq(0,12,0.1),S()$s,1),
    masked_and_vent=N1(0.6,as.numeric(input$q),as.numeric(input$fresh_flow)*as.numeric(input$V)*1.2,seq(0,12,0.1),S()$s*(1-as.numeric(input$maskProp)/100),1)+N1(0.6*0.5,as.numeric(input$q),as.numeric(input$fresh_flow)*as.numeric(input$V)*1.2,seq(0,12,0.1),S()$s*(as.numeric(input$maskProp)/100),1)
    
  )
})

renderPlotly({
  plot_ly(WR(), x=~time, y=~standard,
        name='No mitigation',  hoverinfo = 'text',
        text = ~paste('Number infected: ', round(WR()$standard)),
        type = 'scatter', mode = 'plines') %>%
  add_trace(x=~time, y = ~extra_ventilation, name='Opening an extra window only', mode = 'plines',
            text = ~paste('Increased ventilation by opening an extra window','<br>Number infected: ', round(WR()$extra_ventilation))) %>%
  add_trace(x=~time, y = ~masked, name='With masking only', mode = 'plines',
            text = ~paste('Masked %=',input$maskProp,'<br>Number infected: ', round(WR()$masked))) %>%
    add_trace(x=~time, y = ~masked_and_vent, name='With masking and extra window open', mode = 'plines',
            text = ~paste('Masked %=',input$maskProp, 'and Increased ventilation by opening an extra window','<br>Number infected: ', round(WR()$masked_and_vent))) %>%
  layout(yaxis = list(title = 'Number infected'), 
         # xaxis = list(title = 'Time (hours)')
             xaxis = list(
      rangeslider = list(type = "time"))) # ,legend = list(x = 50, y = 2)
  
# ggplotly(
#  #purrr::map(.x = 1:as.integer(50),myfun) %>%
#   ggplot(data=WR()%>% filter(time<input$tmax) )+ #
#   geom_line(aes(x=time,y=standard),colour="red")+
#   geom_line(aes(x=time,y=extra_ventilation),colour="green")+
#   # geom_line(aes(x=time,y=I),colour="blue")+
#   # geom_line(aes(x=time,y=R),colour="black")+
#   # annotate("text", x = 24, y = 0.5, label = paste("beta=", input$beta,",","R0=",(input$beta)*input$delta/(input$gamma+input$delta)/input$delta))+
#   ylab("Number of Infected People")+
#   xlab("Time[hours]")+
#   # scale_y_continuous(limits=c(0,1))+
#   ggpubr::theme_pubr(base_size = 14)+
#   theme(legend.position="top")
# )
})
```

```{r AUC, echo=FALSE,warning=FALSE}

 # AUC function -------------------------------------------------------
  
  AUC <- function(x,y){ #To allow for non-uniform time-steps
    sum(diff(x[order(x)])*zoo::rollmean(y[order(x)],2))
  }
  

```

### Number of Infected

```{r personograph, echo=FALSE,warning=FALSE}

w <- reactive({
    a<-WR() %>%
      rename("risk"="standard") %>% 
      # filter(name=="C1")%>% #Choose any patient otherwise you're triplicating the subsequent calculations
      select(risk) %>%
      slice_tail(n=1) %>% # last number #FIXME doesn't move with slider
      mutate(NumInfected = list(rbinom(n=100, size = 100, prob = S()$s-risk)))

    #Calculate mean and sd of all values in the nested lists
    ms <- function(a, col="NumInfected") {
      u <- unlist(a[[col]])
      return(data.frame(Mean=ceiling(mean(u)),SD=ceiling(sd(u))))
    }

    a<-ms(a)

    z<-rbind(a,c(100-a$Mean,100-a$SD))
    z<-z/100
    z$Infected <-  as.factor(c("Infected", "Uninfected"))
    data<-list(Infected=1-z$Mean[1], Possibly=z$SD[1],Uninfected=(z$Mean[1]+z$SD[1]) )
    return(data)
  })

renderPlot({

    wafflePlot<-
      w() %>%
      personograph(
        n.icons=S()$s,
        dimensions=c(S()$s,5),
        plot.width=0.8,
        icon.style=2,
        colors=list(Uninfected="grey", Infected="blue",Possibly="orange"),
        force.fill = TRUE,
        fig.cap = "Average number of additional infected occupants (mean=blue, SD=orange)"
      )

    wafflePlot
  })
```

<!-- ```{r} -->
<!-- list(Infected=0.5, Possibly=0.1,Uninfected=1-(0.5+0.1))%>%  -->
<!-- personograph( -->
<!--         n.icons=50, -->
<!--         dimensions=c(5,10), -->
<!--         plot.width=0.8, -->
<!--         icon.style=2, -->
<!--         colors=list(Uninfected="grey", Infected="blue",Possibly="orange"), -->
<!--         force.fill = TRUE, -->
<!--         fig.cap = "Number of additional infected occupants per 100 (mean=blue, SD=orange)" -->
<!--       ) -->
<!-- ``` -->

